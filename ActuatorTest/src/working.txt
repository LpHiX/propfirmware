#include <Arduino.h>
#include <SPI.h>
#include <Wire.h>
#include <ArduinoJson.h>  // Include ArduinoJson library
#include <Adafruit_NeoPixel.h>

// Define the RGB LED pin
#define RGB_LED_PIN 48
#define NUM_PIXELS 1  // Just the one integrated LED

// Initialize NeoPixel object
Adafruit_NeoPixel pixel(NUM_PIXELS, RGB_LED_PIN, NEO_GRB + NEO_KHZ800);

// uint32_t Wheel(byte WheelPos) {
//   WheelPos = 255 - WheelPos;
//   if(WheelPos < 85) {
//     return pixel.Color(255 - WheelPos * 3, 0, WheelPos * 3);
//   }
//   if(WheelPos < 170) {
//     WheelPos -= 85;
//     return pixel.Color(0, WheelPos * 3, 255 - WheelPos * 3);
//   }
//   WheelPos -= 170;
//   return pixel.Color(WheelPos * 3, 255 - WheelPos * 3, 0);
// }

void setup() {
  // Initialize the NeoPixel
  pixel.begin();
  pixel.setPixelColor(0, pixel.Color(255, 0, 0));
  pixel.setBrightness(5);
  
  // Initialize USB Serial for computer communication
  Serial.begin(115200);
  Serial2.setRxBufferSize(4096);
  Serial2.begin(921600, SERIAL_8N1, 18, 17); // TX=18, RX=17 for Raspberry Pi communication
  while (Serial2.available()) { Serial2.read(); }
}

// Non-blocking LED state handling
unsigned long lastLedChangeTime = 0;
bool ledState = false;  // false = red, true = green

void loop() {
  unsigned long currentTime = millis();
  
  // Handle UART data - no delays in this section
  if (Serial2.available()) {
    const int bufferSize = 512;
    char buffer[bufferSize];
    
    // Read multiple bytes at once - much faster than byte-by-byte
    int bytesRead = Serial2.readBytes(buffer, bufferSize - 1);
    
    // Null-terminate the string
    buffer[bytesRead] = 0;
    
    // Process the data
    Serial.print("Received: ");
    Serial.println(buffer);
    
    // Visual indicator
    pixel.setPixelColor(0, pixel.Color(0, 255, 0));
    ledState = true;
    lastLedChangeTime = currentTime;
  }
  
  // Handle LED state in a non-blocking way
  if (ledState && currentTime - lastLedChangeTime > 500) {
    // Change back to red after 500ms
    pixel.setPixelColor(0, pixel.Color(255, 0, 0));
    ledState = false;
  }
  
  // Update LED - happens every loop iteration
  pixel.show();
}